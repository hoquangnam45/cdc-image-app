<?xml version="1.0" encoding="UTF-8"?>
<mxfile host="app.diagrams.net" modified="2024-01-01T00:00:00.000Z" agent="5.0" etag="xxx" version="22.1.16" type="device">
  <diagram name="Authentication Flow" id="auth-flow">
    <mxGraphModel dx="1422" dy="794" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1400" pageHeight="900" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        
        <!-- Title -->
        <mxCell id="title" value="Authentication Flow with KMS Integration" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=20;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="400" y="20" width="500" height="30" as="geometry" />
        </mxCell>
        
        <!-- Actors -->
        <mxCell id="browser" value="Browser" style="shape=umlActor;verticalLabelPosition=bottom;verticalAlign=top;html=1;outlineConnect=0;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
          <mxGeometry x="80" y="100" width="30" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="frontend" value="Frontend&#xa;(Vue.js)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=12;align=center;" vertex="1" parent="1">
          <mxGeometry x="200" y="100" width="120" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="auth-service" value="Auth Service&#xa;(Port 8081)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=12;align=center;" vertex="1" parent="1">
          <mxGeometry x="400" y="100" width="120" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="kms" value="Google KMS" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontSize=12;align=center;" vertex="1" parent="1">
          <mxGeometry x="600" y="100" width="120" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="database" value="PostgreSQL&#xa;Database" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontSize=12;align=center;" vertex="1" parent="1">
          <mxGeometry x="800" y="100" width="120" height="60" as="geometry" />
        </mxCell>
        
        <!-- Lifelines -->
        <mxCell id="browser-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="95" y="180" as="sourcePoint" />
            <mxPoint x="95" y="800" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="frontend-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="260" y="180" as="sourcePoint" />
            <mxPoint x="260" y="800" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="auth-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="460" y="180" as="sourcePoint" />
            <mxPoint x="460" y="800" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="kms-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="660" y="180" as="sourcePoint" />
            <mxPoint x="660" y="800" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="db-line" value="" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="860" y="180" as="sourcePoint" />
            <mxPoint x="860" y="800" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- Messages -->
        <!-- 1. Login Request -->
        <mxCell id="msg1" value="1. Login Request&#xa;{username, password}" style="html=1;verticalAlign=bottom;endArrow=block;fontSize=10;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="95" y="220" as="sourcePoint" />
            <mxPoint x="260" y="220" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- 2. POST /api/auth/login -->
        <mxCell id="msg2" value="2. POST /api/auth/login" style="html=1;verticalAlign=bottom;endArrow=block;fontSize=10;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="260" y="250" as="sourcePoint" />
            <mxPoint x="460" y="250" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- 3. Validate Credentials -->
        <mxCell id="msg3" value="3. Validate Credentials&#xa;SELECT * FROM user WHERE..." style="html=1;verticalAlign=bottom;endArrow=block;fontSize=10;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="460" y="280" as="sourcePoint" />
            <mxPoint x="860" y="280" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- 4. User Data -->
        <mxCell id="msg4" value="4. User Data" style="html=1;verticalAlign=bottom;endArrow=block;dashed=1;fontSize=10;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="860" y="310" as="sourcePoint" />
            <mxPoint x="460" y="310" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- 5. Create JWT Claims -->
        <mxCell id="msg5" value="5. Create JWT Claims&#xa;(user_id, username, email, etc.)" style="html=1;verticalAlign=bottom;endArrow=none;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="460" y="340" as="sourcePoint" />
            <mxPoint x="520" y="340" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- 6. Sign JWT with KMS -->
        <mxCell id="msg6" value="6. Sign JWT with KMS&#xa;AsymmetricSign(claims)" style="html=1;verticalAlign=bottom;endArrow=block;fontSize=10;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="460" y="370" as="sourcePoint" />
            <mxPoint x="660" y="370" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- 7. Signed JWT -->
        <mxCell id="msg7" value="7. Signed JWT Token" style="html=1;verticalAlign=bottom;endArrow=block;dashed=1;fontSize=10;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="660" y="400" as="sourcePoint" />
            <mxPoint x="460" y="400" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- 8. Store Refresh Token -->
        <mxCell id="msg8" value="8. Store Refresh Token&#xa;INSERT INTO refresh_token..." style="html=1;verticalAlign=bottom;endArrow=block;fontSize=10;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="460" y="430" as="sourcePoint" />
            <mxPoint x="860" y="430" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- 9. JWT + Cookies -->
        <mxCell id="msg9" value="9. JWT + HTTP-Only Cookies&#xa;{accessToken, refreshToken}" style="html=1;verticalAlign=bottom;endArrow=block;dashed=1;fontSize=10;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="460" y="460" as="sourcePoint" />
            <mxPoint x="260" y="460" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- 10. Auth Success -->
        <mxCell id="msg10" value="10. Authentication Success" style="html=1;verticalAlign=bottom;endArrow=block;dashed=1;fontSize=10;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="260" y="490" as="sourcePoint" />
            <mxPoint x="95" y="490" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- Token Refresh Section -->
        <mxCell id="refresh-title" value="Token Refresh Flow (Automatic)" style="text;html=1;strokeColor=none;fillColor=#fff2cc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=14;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="400" y="540" width="300" height="30" as="geometry" />
        </mxCell>
        
        <!-- 11. Timer Triggers -->
        <mxCell id="msg11" value="11. Timer Triggers&#xa;(60s before expiry)" style="html=1;verticalAlign=bottom;endArrow=none;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="260" y="590" as="sourcePoint" />
            <mxPoint x="320" y="590" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- 12. POST /api/auth/refresh -->
        <mxCell id="msg12" value="12. POST /api/auth/refresh&#xa;(with refresh cookie)" style="html=1;verticalAlign=bottom;endArrow=block;fontSize=10;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="260" y="620" as="sourcePoint" />
            <mxPoint x="460" y="620" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- 13. Validate Refresh Token -->
        <mxCell id="msg13" value="13. Validate Refresh Token&#xa;SELECT * FROM refresh_token..." style="html=1;verticalAlign=bottom;endArrow=block;fontSize=10;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="460" y="650" as="sourcePoint" />
            <mxPoint x="860" y="650" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- 14. Generate New JWT -->
        <mxCell id="msg14" value="14. Generate New JWT&#xa;Sign with KMS" style="html=1;verticalAlign=bottom;endArrow=block;fontSize=10;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="460" y="680" as="sourcePoint" />
            <mxPoint x="660" y="680" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- 15. New JWT + Cookies -->
        <mxCell id="msg15" value="15. New JWT + Cookies" style="html=1;verticalAlign=bottom;endArrow=block;dashed=1;fontSize=10;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="460" y="710" as="sourcePoint" />
            <mxPoint x="260" y="710" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- 16. Schedule Next Refresh -->
        <mxCell id="msg16" value="16. Schedule Next Refresh" style="html=1;verticalAlign=bottom;endArrow=none;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" edge="1" parent="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="260" y="740" as="sourcePoint" />
            <mxPoint x="320" y="740" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- Notes -->
        <mxCell id="note1" value="Key Points:&#xa;• Auth Service signs JWT using KMS private key&#xa;• Each microservice caches KMS public key for validation&#xa;• Frontend automatically refreshes tokens before expiry&#xa;• Refresh tokens stored securely in HTTP-only cookies" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=11;align=left;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="1000" y="200" width="300" height="120" as="geometry" />
        </mxCell>
        
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>

